GorillaMedia = {
  textExtensions: [
    '.txt', '.csv', '.json', '.js', '.ts', '.html', '.css',
    '.xml', '.svg', '.md', '.log', '.config', '.yml', '.yaml',
    '.license'],
  icons: {
    css:"<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M64,32,99,435.22,255.77,480,413,435.15,448,32ZM354.68,366.9,256.07,395l-98.46-28.24L150.86,289h48.26l3.43,39.56,53.59,15.16.13.28h0l53.47-14.85L315.38,265H203l-4-50H319.65L324,164H140l-4-49H376.58Z\"/></svg>",
    image: "<svg xmlns=\"http://www.w3.org/2000/svg\"  viewBox=\"0 0 512 512\"><rect x=\"48\" y=\"80\" width=\"416\" height=\"352\" rx=\"48\" ry=\"48\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><circle cx=\"336\" cy=\"176\" r=\"32\" style=\"fill:none;stroke:#000;stroke-miterlimit:10;stroke-width:32px\"/><path d=\"M304,335.79,213.34,245.3A32,32,0,0,0,169.47,244L48,352\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><path d=\"M224,432,347.34,308.66a32,32,0,0,1,43.11-2L464,368\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/></svg>",

    video: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><rect x=\"48\" y=\"96\" width=\"416\" height=\"320\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"384\" y=\"336\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"384\" y=\"256\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"384\" y=\"176\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"384\" y=\"96\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"48\" y=\"336\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"48\" y=\"256\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"48\" y=\"176\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"48\" y=\"96\" width=\"80\" height=\"80\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"128\" y=\"96\" width=\"256\" height=\"160\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><rect x=\"128\" y=\"256\" width=\"256\" height=\"160\" rx=\"28\" ry=\"28\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/></svg>",

    audio: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M192,218v-6c0-14.84,10-27,24.24-30.59l174.59-46.68A20,20,0,0,1,416,154V176\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><path d=\"M416,295.94v80c0,13.91-8.93,25.59-22,30l-22,8c-25.9,8.72-52-10.42-52-38h0a33.37,33.37,0,0,1,23-32l51-18.15c13.07-4.4,22-15.94,22-29.85V58a10,10,0,0,0-12.6-9.61L204,102a16.48,16.48,0,0,0-12,16v226c0,13.91-8.93,25.6-22,30l-52,18c-13.88,4.68-22,17.22-22,32h0c0,27.58,26.52,46.55,52,38l22-8c13.07-4.4,22-16.08,22-30v-80\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/></svg>",

    font: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M292.6,407.78l-120-320a22,22,0,0,0-41.2,0l-120,320a22,22,0,0,0,41.2,15.44L88.76,326.8a2,2,0,0,1,1.87-1.3H213.37a2,2,0,0,1,1.87,1.3l36.16,96.42a22,22,0,0,0,41.2-15.44Zm-185.84-129,43.37-115.65a2,2,0,0,1,3.74,0L197.24,278.8a2,2,0,0,1-1.87,2.7H108.63A2,2,0,0,1,106.76,278.8Z\"/><path d=\"M400.77,169.5c-41.72-.3-79.08,23.87-95,61.4a22,22,0,0,0,40.5,17.2c8.88-20.89,29.77-34.44,53.32-34.6C431.91,213.28,458,240,458,272.35h0a1.5,1.5,0,0,1-1.45,1.5c-21.92.61-47.92,2.07-71.12,4.8C330.68,285.09,298,314.94,298,358.5c0,23.19,8.76,44,24.67,58.68C337.6,430.93,358,438.5,380,438.5c31,0,57.69-8,77.94-23.22,0,0,.06,0,.06,0h0a22,22,0,1,0,44,.19v-143C502,216.29,457,169.91,400.77,169.5ZM380,394.5c-17.53,0-38-9.43-38-36,0-10.67,3.83-18.14,12.43-24.23,8.37-5.93,21.2-10.16,36.14-11.92,21.12-2.49,44.82-3.86,65.14-4.47a2,2,0,0,1,2,2.1C455,370.1,429.46,394.5,380,394.5Z\"/></svg>",
    text: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M416,221.25V416a48,48,0,0,1-48,48H144a48,48,0,0,1-48-48V96a48,48,0,0,1,48-48h98.75a32,32,0,0,1,22.62,9.37L406.63,198.63A32,32,0,0,1,416,221.25Z\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><path d=\"M256,56V176a32,32,0,0,0,32,32H408\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"176\" y1=\"288\" x2=\"336\" y2=\"288\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"176\" y1=\"368\" x2=\"336\" y2=\"368\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/></svg>",

    generic: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M416,221.25V416a48,48,0,0,1-48,48H144a48,48,0,0,1-48-48V96a48,48,0,0,1,48-48h98.75a32,32,0,0,1,22.62,9.37L406.63,198.63A32,32,0,0,1,416,221.25Z\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/><path d=\"M256,56V176a32,32,0,0,0,32,32H408\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/></svg>",

    glasses: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M464,184H453.1a78.72,78.72,0,0,0-16-7.18C419.5,171,396.26,168,368,168s-51.5,3-69.06,8.82c-14.06,4.69-20.25,9.86-22.25,11.87h0a47.94,47.94,0,0,0-41.36,0h0c-2-2-8.19-7.18-22.25-11.87C195.5,171,172.26,168,144,168s-51.5,3-69.06,8.82a78.72,78.72,0,0,0-16,7.18H48a16,16,0,0,0,0,32h.17c1,45.46,6.44,72.78,18.11,92.23a66.78,66.78,0,0,0,31.92,28c12.23,5.24,27.22,7.79,45.8,7.79,24.15,0,58.48-3.71,77.72-35.77,9.68-16.14,15.09-37.69,17.21-70.52A16,16,0,0,0,240,232a16,16,0,0,1,32,0,16,16,0,0,0,1.07,5.71c2.12,32.83,7.53,54.38,17.21,70.52a66.78,66.78,0,0,0,31.92,28c12.23,5.24,27.22,7.79,45.8,7.79,24.15,0,58.48-3.71,77.72-35.77,11.67-19.45,17.13-46.77,18.11-92.23H464a16,16,0,0,0,0-32Z\"/></svg>",


    trash: "<svg xmlns=\"http://www.w3.org/2000/svg\"  viewBox=\"0 0 512 512\"><path d=\"M112,112l20,320c.95,18.49,14.4,32,32,32H348c17.67,0,30.87-13.51,32-32l20-320\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"80\" y1=\"112\" x2=\"432\" y2=\"112\" style=\"stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px\"/><path d=\"M192,112V72h0a23.93,23.93,0,0,1,24-24h80a23.93,23.93,0,0,1,24,24h0v40\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"256\" y1=\"176\" x2=\"256\" y2=\"400\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"184\" y1=\"176\" x2=\"192\" y2=\"400\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/><line x1=\"328\" y1=\"176\" x2=\"320\" y2=\"400\" style=\"fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px\"/></svg>",
    undo: "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M240,424V328c116.4,0,159.39,33.76,208,96,0-119.23-39.57-240-208-240V88L64,256Z\" style=\"fill:none;stroke:#000;stroke-linejoin:round;stroke-width:32px\"/></svg>",




  },
  dirty: false,
  init: function () {

    // Handle selected file
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) GorillaMedia.handleFile(e.target.files[0]);
    });
    dropZone.addEventListener('click', (e) => {
      fileInput.click();
    });


    // Drag & drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files[0]) GorillaMedia.handleFile(e.dataTransfer.files[0]);
    });
    document.getElementById("gorilla-media-screen-empty-trash").addEventListener("click", async function () {
      await GorillaMedia.emptyTrash();
    });
  },

  loadMediaScreens: async function () {
    await GorillaMedia.loadMediaScreen("media", "gorilla-media-list");
   // await GorillaMedia.loadMediaScreen("fonts", "gorilla-media-font-list");
   // await GorillaMedia.loadMediaScreen("licenses", "gorilla-media-license-list");
    await GorillaMedia.loadMediaScreen("trash", "gorilla-media-trash-list");
    await GorillaFontLoader.loadFonts();

  },
  loadMediaScreen: async function (folder, elementId) {
    let medialist = document.getElementById(elementId);
    let mediafiles = [];
    let pathinfo = {};
    medialist.innerHTML = "";
    mediafiles = await fs.readDirectory(folder + "/");

    for (const file of mediafiles) {
      const li = document.createElement("li");
      li.class = "gorilla-media-item";
      pathinfo = GorillaMedia.splitFilePath(file);
      let basefilename = pathinfo.basePath.replace(folder + "/", "");
      li.setAttribute("original-folder", folder);
      li.setAttribute("original-file-path", basefilename);
      if (pathinfo.extension) {
        li.setAttribute("original-file-extension", pathinfo.extension);
      }
      else {
        li.setAttribute("original-file-extension", "");
      }

      li.innerHTML = GorillaMedia.getFileIcon(pathinfo.extension) + " " + "<span class=\"gorilla-media-file-name\" contenteditable=\"plaintext-only\">" + basefilename + "</span>"

      if (folder !== "trash")
        li.innerHTML += "<span class='gorilla-media-trash-icon' filename='" + file + "' title='Move to Trash'>" + GorillaMedia.icons.trash + "</span>";
      else li.innerHTML += "<span class='gorilla-media-undo-icon' filename='" + file + "' title='Restore from Trash'>" + GorillaMedia.icons.undo + "</span>";

      medialist.appendChild(li);
    }

    // Remove ALL old listeners first by cloning elements
    document.querySelectorAll('.gorilla-media-file-name').forEach(span => {
      const newSpan = span.cloneNode(true);
      span.parentNode.replaceChild(newSpan, span);
    });
    document.querySelectorAll('.gorilla-media-trash-icon').forEach(span => {
      const newSpan = span.cloneNode(true);
      span.parentNode.replaceChild(newSpan, span);
    });
    document.querySelectorAll('.gorilla-media-undo-icon').forEach(span => {
      const newSpan = span.cloneNode(true);
      span.parentNode.replaceChild(newSpan, span);
    });
    // Now attach fresh listeners
    document.querySelectorAll('.gorilla-media-file-name').forEach(span => {
      span.addEventListener('blur', GorillaMedia.handleFileRename);
    });
    document.querySelectorAll('.gorilla-media-trash-icon').forEach(icon => {
      icon.addEventListener('click', async (event) => {
        const filename = event.currentTarget.getAttribute('filename');
        const trashPath = "trash/" + filename.split('/').pop();
        await fs.renameFile(filename, trashPath);
        setTimeout(() => { GorillaMedia.loadMediaScreens(); }, 100);
        event.stopPropagation();
        event.preventDefault();
      });
    });
    document.querySelectorAll('.gorilla-media-undo-icon').forEach(icon => {
      icon.addEventListener('click', async (event) => {
        const trashPath = event.currentTarget.getAttribute('filename');
        const basePath = trashPath.split('/').pop();
        const originalFileName = GorillaMedia.getFolderLocation(basePath);
        await fs.renameFile(trashPath, originalFileName);
        setTimeout(() => { GorillaMedia.loadMediaScreens(); }, 100);
        event.stopPropagation();
        event.preventDefault();

      });
    });
  },

  handleFileRename: async function (event) {
    const span = event.target;
    const li = span.closest('li');
    if (!li) return;

    const originalFolder = li.getAttribute("original-folder");
    const originalBasePath = li.getAttribute("original-file-path");
    const extension = li.getAttribute("original-file-extension");

    if (!originalBasePath || extension === undefined) {
      GorillaPresenter.notify('Missing name or extension for media file');
      return;
    }

    let updatedName = span.textContent.trim();
    updatedName = updatedName.replace(/\s+/g, ' ');

    if (updatedName === '') {
      GorillaPresenter.notify('Filename cannot be empty');
      return;
    }

    let newFilename = originalFolder + "/" + updatedName + (extension ? '.' + extension : '');
    newFilename = newFilename.replace(/\.{2,}/g, '.');
    const oldFilename = originalFolder + "/" + originalBasePath + (extension ? '.' + extension : '');
    if (oldFilename === newFilename) {
      return; // No change
    }
    GorillaPresenter.markDirty(true);
    fs.zipModified = true;
    await fs.renameFile(oldFilename, newFilename);
    setTimeout(() => { GorillaMedia.loadMediaScreens(); }, 100);
  },

  showMediaScreen: async function () {
    await GorillaMedia.loadMediaScreens();
    GorillaPresenter.show_screen("gorilla-media-screen");
  },

  splitFilePath: function (filePath) {
    // Normalize separators for consistency (optional)
    const normalized = filePath.replace(/\\/g, '/');

    // Find last slash to separate directory from filename
    const lastSlash = normalized.lastIndexOf('/');
    const dir = lastSlash === -1 ? '' : normalized.slice(0, lastSlash);
    const filename = lastSlash === -1 ? normalized : normalized.slice(lastSlash + 1);

    // Extract extension from filename
    const lastDot = filename.lastIndexOf('.');
    let name, ext;
    if (lastDot === -1 || lastDot === 0) {  // No dot or hidden file like ".gitignore"
      name = filename;
      ext = null;
    } else {
      name = filename.slice(0, lastDot);
      ext = filename.slice(lastDot + 1);
    }

    const basePath = dir ? `${dir}/${name}` : name;

    return { basePath, extension: ext };
  },


  getFileIcon: function (extension) {
    switch (extension) {
      case "png":
      case "jpg":
      case "jpeg":
      case "gif":
      case "bmp":
      case "svg":
      case "webp":
        return GorillaMedia.icons.image; // Image icon
      case "mp4":
      case "mov":
      case "avi":
      case "webm":
        return GorillaMedia.icons.video; // Video icon
      case "mp3":
      case "wav":
        return GorillaMedia.icons.audio; // Audio icon
      case "license":
        return GorillaMedia.icons.glasses; // License icon
      case "ttf":
      case "otf":
      case "woff":
      case "woff2":
        return GorillaMedia.icons.font; // Font icon
      case "css":
        return GorillaMedia.icons.css; // CSS icon
      case "txt":
      case "md":
      case "json":
      case "js":
      case "ts":
      case "html":
      case "xml":
      case "csv":
      case "log":
      case "config":
      case "yml":
      case "yaml":
        return GorillaMedia.icons.text; // Font icon
      default:
        return GorillaMedia.icons.generic; // Generic file icon
    }
  },
  getFolderLocation: function (filename) {

    if (filename.match(/\.ttf$/i) || filename.match(/\.otf$/i) || filename.match(/\.woff$/i) || filename.match(/\.woff2$/i)) {
     // return "fonts/" + filename;
      return "media/" + filename;
    }
   /* else if (filename.match(/\.license$/i)) {
      return "licenses/" + filename;
    }*/
    else {
      return "media/" + filename;
    }
  },
  findMediaFile: async function (mediaSpec) {
    // Wildcard the search.
    let searchSpec = mediaSpec.toLowerCase();
    let mediafiles = await fs.readDirectory("media/");
    for (const file of mediafiles) {
      if (file.toLowerCase().includes(searchSpec)) {
        return file;
      }
    }
    console.warn("No media file found matching spec: " + mediaSpec);
    return null;
  },
  handleFile: async function (file) {
    const fileName = file.name.toLowerCase();
    const isTextFile = GorillaMedia.textExtensions.some(ext => fileName.endsWith(ext));

    filePath = GorillaMedia.getFolderLocation(file.name);
    if (isTextFile) {
      await fs.writeTextFile(filePath, await file.text());
    }
    else {
      await fs.writeBinaryFile(filePath, file); // Default to binary write
    }
    await GorillaMedia.loadMediaScreens();
    fs.zipModified = true;
    GorillaPresenter.markDirty(true);
  },
  emptyTrash: async function () {
    let mediafiles = await fs.readDirectory("trash/");
    if (mediafiles.length === 0) {
      GorillaPresenter.notify("Trash is already empty.");
      return;
    }
    let okayToTrash = await GorillaPresenter.confirm("Are you sure you want to permanently delete all items in the Trash? This action cannot be undone.");
    if (!okayToTrash) {
      return;
    }
    for (const file of mediafiles) {
      await fs.deleteFile(file);
    }
    await GorillaMedia.loadMediaScreens();
    GorillaPresenter.markDirty(true);
  },
}
